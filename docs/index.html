<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/x-icon"
    href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAfYA8/j3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREAABERAAAREQAAEREAABERAAAREQAAEREAABERAAAAABERAAAREQAAEREAABERAAAREQAAEREAABERAAARERERAAAREQAAEREAABERAAAREQAAEREAABERAAAREQAAAAAREQAAEREAABERAAAREQAAEREAABERAAAREQAAEREAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">

  <title>Non-Stop YouTube&trade; for iOS</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
    }
    dialog:-internal-dialog-in-top-layer::backdrop {
      position: fixed;
      inset: 0px;
      background: rgba(0, 0, 0, 0.5);
    }
    #player-container {
      width: 100%;
      height: 99vh;
    }
    #ctrl-panel form p {
      margin-block-start: .6em;
      margin-block-end: .6em;
    }
    #ctrl-panel form p:first-child {
      margin-block-start: 0;
    }
    #ctrl-panel form textarea {
      display: block;
      width: 90%;
    }
    #ctrl-panel form #btnArea {
      display: flex;
      justify-content: space-evenly;
    }
  </style>
</head>
<body>
  <div id="player-container"></div>
  <dialog id="ctrl-panel" method="dialog">
    <form>
      <p>
        <label for="urlList">YouTube Video IDs or URLs:</label>
        <textarea name="urlList" id="urlList" rows="3" cols="20" placeholder="aqz-KE-bpKQ"></textarea>
      </p>
      <div id="btnArea">
        <button value="cancel" formmethod="dialog">Cancel</button>
        <button type="button" id="confirmBtn" >Confirm</button>
      </div>
    </form>
  </dialog>

  <script async src="https://www.youtube.com/iframe_api"></script>
  <script>
    // access `/#v=aqz-KE-bpKQ` for testing
    window.addEventListener('load', () => {
      console.log('Ready!!');
      const dialog = document.getElementById('ctrl-panel');
      const container = document.getElementById('player-container');

      container.addEventListener('click', () => {
        console.log('Container clicked!!', dialog.open);
        if (!dialog.open) dialog.showModal();
      });

      dialog.addEventListener('close', () => {
        console.log('Dialog closed!!');

        if (window.YTplayer) {
          window.YTplayer.playVideo();
        }
      });

      document.getElementById('confirmBtn').addEventListener('click', () => {
        const form = document.querySelector('dialog form');
        const formParams = parseForm(form);
        const hashParams = parseHash(window.location.hash);
        const list = formParams.list || [];
        const videoId = hashParams['v'] || list[0];

        if (list.length > 1) {
          hashParams['v'] = videoId;
          hashParams['l'] = list.join(',');
          window.location.hash = (new URLSearchParams(hashParams)).toString();
        } else {
          return;
        }

        dialog.close();
      });

      const params = parseHash(window.location.hash);
      console.log(params);
      if (params['v'] || params['l']) {
        dialog.close();
        updateForm(document.querySelector('dialog form'), params);

        if (!window.YTplayer)
          window.YTplayer = createPlayer(params['v'], params['l']);
        else
          window.YTplayer.cuePlaylist(params['v']);
      } else {
        dialog.showModal();
      }
    });

    window.addEventListener('hashchange', () => {
      console.log("The hash has changed!");

      const params = parseHash(window.location.hash);
      console.log(params);

      const dialog = document.getElementById('ctrl-panel');

      if (params['v']) {
        createPlayer(params['v']);
        dialog.close();
        updateForm(document.querySelector('dialog form'), params);
      } else {
        dialog.showModal();
      }
    });


  </script>
  <script>
    const parseHash = (hash = '') => {
      const result = {};
      for (const [key, value] of new URLSearchParams(hash.replace('#', ''))) {
        if (result[key]) {
          result[key] = `${result[key]},${value}`;
        } else {
          result[key] = value;
        }
      }
      return result;
    };

    const parseForm = (form) => {
      return Object.values(form.elements).reduce((res, field) => {
        if (field.name) {
          if (field.name === 'urlList') {
            res['list'] = parseUrlList(field.value);
          }
          res[field.name] = field.value;
        }
        return res;
      }, {});
    };

    const parseUrlList = (urls) => {
      return urls.split(/\r\n|\n|\r|\t|,/).map(u => {
        try {
          const url = new URL(u.trim());
          if (url.host.includes('youtu.be')) {
            return url.pathname.replace('/', '');
          } else {
            return url.searchParams.get('v');
          }
        } catch (_error) {
          return u.trim();
        }
      }).filter(u => u);
    };

    const updateForm = (form, params) => {
      const list = params['l'].split(',').map(id => id.trim());
      // list.unshift(params['v']);
      params.urlList = list.join('\n');

      for (const [key, value] of Object.entries(params)) {
        const field = form.elements[key];
        if (field) {
          field.value = value;
        }
      }
    };
  </script>
  <script>
    function createPlayer(videoId, playlist) {
      console.log('onYouTubeIframeAPIReady:', videoId);

      playlist = playlist || videoId;

      return new YT.Player('player-container', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        host: 'https://www.youtube-nocookie.com',
        playerVars: {
          origin: window.location.host,
          autoplay: 0,
          loop: 0,
          playlist: playlist
        },
        events: {
          onReady, onStateChange,
        }
      });
    }
    function onReady(event) {
      console.log('onPlayerReady:', event);
      event.target.playVideo();
    }

    function onStateChange(event) {
      console.log('onStateChange:', event);
      switch (event.data) {
        case YT.PlayerState.UNSTARTED:
          break;
        case YT.PlayerState.ENDED:
          break;
        case YT.PlayerState.PLAYING:
          document.getElementById('ctrl-panel').close();
          break;
        case YT.PlayerState.PAUSED:
          document.getElementById('ctrl-panel').showModal();
          break;
        case YT.PlayerState.BUFFERING:
          break;
        case YT.PlayerState.CUED:
          break;
        // default:
      }
    }
  </script>
</body>
</html>
